<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width">

    <title>Promise example</title>

    <script src="js/jquery-2.1.3.min.js"></script>
</head>

<body>
<div class="progressBars">
    <article class="book example">
        <h1 class="title">${title}</h1> <img class="loader" src="image/ajax-loader-dark.gif">
    </article>

</div>


</body>

<script>

        function getOnlineOfflineStatus(userId) {
            return new Promise(function(resolve, reject) {
                // Standard XHR to load an image
                var request = new XMLHttpRequest();

                request.open('GET', "/sss?user_id="+userId);
                //request.responseType = 'blob';

                // When the request loads, check whether it was successful
                request.onload = function() {
                    if (request.status === 200) {
                        // If successful, resolve the promise by passing back the request response
                        resolve(request.response);
                    } else {
                        // If it fails, reject the promise with a error message
                        reject(Error('Unable to get user status:' + request.statusText));
                    }
                };

                request.onerror = function() {
                    // Also deal with the case when the entire request fails to begin with
                    // This is probably a network error, so reject the promise with an appropriate message
                    reject(Error('network error.'));
                };

                // Send the request
                request.send();
            }).then(JSON.parse);
        }


        var signalStartUpload = function () {
            var singleBarExample = $('.book.example').removeClass('example');
            singleBarExample.remove();
            return function(userId) {
                return new Promise(function (resolve, reject) {
                    var clone = singleBarExample.clone(false);
                    clone.attr('id', userId);
                    var titleLink = clone.find('.title');
                    titleLink.text("user: " + userId);
                    $('.progressBars').append(clone);
                    resolve();
                });
            }

        }();

        function signalStopUpload(userId) {
            return new Promise(function(resolve, reject) {
                $(".book#"+userId).find("img").hide();
                console.log("end",userId);
                resolve();
            })

        }

        var N = 600;
        var userIds = Array.apply(null, {length: N}).map(Number.call, Number);
        var userStatus = {};

        var completed = userIds.reduce(function(promise, currentUserId){
            return promise.then(function(){
                return currentUserId;
            }).then(function(userId){
                return signalStartUpload(userId).then(function(){
                    return getOnlineOfflineStatus(userId)
                }).then(function(onlineOffline){
                    userStatus[userId] = onlineOffline.online;
                }).catch(function(err){
                    userStatus[userId] = err;
                }).then(function(){
                    return signalStopUpload(userId)
                });
            })
        },Promise.resolve())

        completed.then(function(){
            console.log("done");
            console.log(userStatus);
        })


</script>
</html>