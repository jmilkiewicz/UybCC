<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width">

    <title>Promise example</title>

    <script src="js/jquery-2.1.3.min.js"></script>
</head>

<body>
<div class="progressBars">
    <article class="book example">
        <h1 class="title">${title}</h1>
        <img class="loader" src="image/ajax-loader-dark.gif">
        <img class="online" src="image/online.png">
        <img class="offline" src="image/offline.png">
        <img class="error" src="image/error.jpg">
    </article>

</div>


</body>

<script>

        function getOnlineOfflineStatus(userId) {
            return new Promise(function(resolve, reject) {
                // Standard XHR to load an image
                var request = new XMLHttpRequest();

                request.open('GET', "/sss?user_id="+userId);
                //request.responseType = 'blob';

                // When the request loads, check whether it was successful
                request.onload = function() {
                    if (request.status === 200) {
                        // If successful, resolve the promise by passing back the request response
                        resolve(request.response);
                    } else {
                        // If it fails, reject the promise with a error message
                        reject(Error('Unable to get user status:' + request.statusText));
                    }
                };

                request.onerror = function() {
                    // Also deal with the case when the entire request fails to begin with
                    // This is probably a network error, so reject the promise with an appropriate message
                    reject(Error('network error.'));
                };

                // Send the request
                request.send();
            }).then(JSON.parse);
        }


        var userOnline = function(){
            var online= true;
            return {
                render: function(elem){
                    elem.find(".online").show();
                },
                status : function(){
                    return {online:online}
                }
            }
        }

        var userOffline = function(){
            var online= false;
            return {
                render: function(elem){
                    elem.find(".offline").show();
                },
                status : function(){
                    return {online:online}
                }
            }
        }

        var userStatusError = function(err){
            return {
                render: function(elem){
                    elem.find(".error").show();
                },
                status : function(){
                    return {error:err}
                }
            }
        }


        var onGetUserStatusStart = function () {
            var singleBarExample = $('.book.example').removeClass('example');
            singleBarExample.remove();
            return function(userId) {
                    var clone = singleBarExample.clone(false);
                    clone.attr('id', userId);
                    var titleLink = clone.find('.title');
                    titleLink.text("user: " + userId);
                    clone.find("img").hide();
                    clone.find(".loader").show();
                    $('.progressBars').append(clone);


            }

        }();

        function onGetUserStatusEnd(userId) {
                var elem = $(".book#"+userId);
                elem.find("img").hide();
                userStatus[userId].render(elem);
                console.log("end",userId);
        }

        var N = 100;
        var userIds = Array.apply(null, {length: N}).map(Number.call, Number);
        var userStatus = {};

        function buildUserStatus(online) {
            if(online){
                return userOnline();
            }
            return userOffline();

        }
        var completed = userIds.reduce(function(promise, currentUserId){
            return promise.then(function(){
                onGetUserStatusStart(currentUserId)
            }).then(function(){
                return getOnlineOfflineStatus(currentUserId)
            }).then(function(onlineOffline){
                userStatus[currentUserId] = buildUserStatus(onlineOffline.online);
            }).catch(function(err){
                userStatus[currentUserId] = userStatusError(err);
            }).then(function(){
                onGetUserStatusEnd(currentUserId);
            });
        },Promise.resolve())

        completed.then(function(){
            var payload = Object.keys(userStatus).reduce(function(previous, key){
               previous[key] = userStatus[key].status();
               return previous;
            }, {});

            console.log(payload);

        })


</script>
</html>