<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width">

    <title>Promise example</title>

    <link rel="stylesheet" href="">
    <!--[if lt IE 9]>
    <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
</head>

<body>
<h1>Promise example</h1>

<p>Darth Vader image by <a href="https://www.flickr.com/photos/digital_stability/">Shawn Taylor</a>, published under a <a href="https://creativecommons.org/licenses/by-nc-nd/2.0/">Attribution-NonCommercial-NoDerivs 2.0 Generic</a> license.</p>
</body>

<script>

    function getOnlineOfflineStatus(userId) {
        return new Promise(function(resolve, reject) {
            // Standard XHR to load an image
            var request = new XMLHttpRequest();

            request.open('GET', "/sss?user_id="+userId);
            //request.responseType = 'blob';

            // When the request loads, check whether it was successful
            request.onload = function() {
                if (request.status === 200) {
                    // If successful, resolve the promise by passing back the request response
                    resolve(request.response);
                } else {
                    // If it fails, reject the promise with a error message
                    reject(Error('Image didn\'t load successfully; error code:' + request.statusText));
                }
            };

            request.onerror = function() {
                // Also deal with the case when the entire request fails to begin with
                // This is probably a network error, so reject the promise with an appropriate message
                reject(Error('There was a network error.'));
            };

            // Send the request
            request.send();
        }).then(JSON.parse);
    }


    function signalStartUpload(userId) {
        return new Promise(function(resolve, reject) {
            console.log("start",userId);
            resolve();
        })

    }

    function signalStopUpload(userId) {
        return new Promise(function(resolve, reject) {
            console.log("end",userId);
            resolve();
        })

    }

    var N = 600;
    var userIds = Array.apply(null, {length: N}).map(Number.call, Number);

    var userStatus = {};

    var completed = userIds.reduce(function(promise, currentUserId){
        return promise.then(function(){
            return currentUserId;
        }).then(function(userId){
            return signalStartUpload(userId).then(function(){
                return getOnlineOfflineStatus(userId)
            }).then(function(onlineOffline){
                return signalStopUpload(userId).then(function(){
                    userStatus[userId] = onlineOffline.online;
                })
            }).catch(function(err){
                userStatus[userId] = err;
            });
        })
    },Promise.resolve())

    completed.then(function(){
        console.log("done");
        console.log(userStatus);
    })

</script>
</html>